<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pollinations AI - Audio Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #e4e4e7; height: 100dvh; overflow: hidden; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-right-enter-active, .slide-right-leave-active { transition: transform 0.3s ease; }
        .slide-right-enter-from, .slide-right-leave-to { transform: translateX(100%); }
    </style>
</head>
<body class="bg-black text-zinc-300">
    <div id="app" class="flex w-full h-full relative">
        
        <!-- ================= CUSTOM MODAL ================= -->
        <transition name="fade">
            <div v-if="modal.show" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm">
                <div class="bg-zinc-900 border border-white/10 p-6 rounded-2xl max-w-sm w-full mx-4 shadow-2xl transform transition-all scale-100">
                    <h3 class="text-lg font-bold text-white mb-2 tracking-tight">{{ modal.title }}</h3>
                    <p class="text-sm text-zinc-400 mb-6 font-light leading-relaxed">{{ modal.message }}</p>
                    
                    <!-- CAPTCHA Display & Input -->
                    <div v-if="modal.type === 'captcha'" class="mb-6">
                        <div class="bg-zinc-800 p-4 rounded-lg text-center mb-4 font-mono text-2xl tracking-[0.5em] font-bold text-white select-none relative overflow-hidden border border-white/5">
                            {{ modal.captchaTarget }}
                            <!-- Visual Noise -->
                            <div class="absolute inset-0 opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1IiBoZWlnaHQ9IjUiPgo8cmVjdCB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMSIvPjwvc3ZnPg==')]"></div>
                        </div>
                        <input ref="modalInput"
                               v-model="modal.inputValue"
                               type="text"
                               class="w-full bg-black border border-white/10 rounded-lg p-3 text-sm text-white focus:border-blue-500/50 outline-none text-center uppercase tracking-widest font-mono"
                               placeholder="TYPE CODE"
                               @keydown.enter="handleModalConfirm">
                    </div>

                    <div class="flex gap-3 justify-end">
                        <button v-if="modal.type !== 'alert'" @click="modal.show = false" class="px-4 py-2 text-xs font-medium text-zinc-400 hover:text-white transition-colors">Cancel</button>
                        <button @click="handleModalConfirm" class="px-4 py-2 text-xs font-medium bg-white text-black rounded-lg hover:bg-zinc-200 transition-colors shadow-lg shadow-white/10">Confirm</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Left Sidebar (History & Nav) -->
        <div class="fixed inset-y-0 left-0 z-40 w-80 bg-black border-r border-white/5 flex flex-col transition-transform duration-300 transform md:relative md:translate-x-0"
             :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'">
            
            <div class="p-5 border-b border-white/5">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-2 font-semibold text-white tracking-tight">
                        <i class="fa-solid fa-music text-purple-500 text-sm"></i><span>Audio Studio</span>
                    </div>
                    <button @click="sidebarOpen = false" class="md:hidden text-zinc-500"><i class="fa-solid fa-times"></i></button>
                </div>
                <!-- Navigation -->
                <div class="flex bg-zinc-900 p-1 rounded-xl border border-white/5 mb-4">
                    <a href="index.html" class="flex-1 py-2 text-xs font-medium rounded-lg text-zinc-500 hover:text-zinc-300 transition-all text-center tracking-wide">Chat</a>
                    <button class="flex-1 py-2 text-xs font-medium rounded-lg bg-zinc-800 text-white shadow-lg transition-all text-center tracking-wide">Audio</button>
                </div>
            </div>

            <!-- History -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <h3 class="text-[10px] uppercase font-bold text-zinc-500 tracking-widest">History</h3>
                <div v-if="audioHistory.length === 0" class="text-center text-zinc-700 text-xs py-10">No audio generated yet.</div>
                <div v-for="(item, idx) in audioHistory" :key="item.id" class="bg-zinc-900/50 p-3 rounded-xl border border-white/5 group hover:border-purple-500/30 transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-medium text-zinc-300 truncate w-40" :title="item.text">{{ item.text }}</span>
                        <!-- Fixed: Removed opacity-0 -->
                        <button @click="confirmDelete(item.id)" class="text-zinc-600 hover:text-red-400 transition-opacity"><i class="fa-solid fa-trash text-xs"></i></button>
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-[10px] px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400 border border-white/5 uppercase">{{ item.voice }}</span>
                        <span class="text-[10px] text-zinc-500">{{ new Date(item.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) }}</span>
                    </div>
                    <audio controls :src="item.url" class="w-full h-8 rounded opacity-80 hover:opacity-100 transition-opacity"></audio>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-white/5 bg-black">
                <button v-if="!apiKey" @click="login" class="w-full py-2.5 px-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-medium text-xs shadow-lg flex items-center justify-center gap-2">
                    <i class="fa-solid fa-bolt"></i><span>Connect Pollinations</span>
                </button>
                <div v-else class="flex flex-col gap-2">
                     <div class="px-3 py-2 bg-zinc-900/50 rounded-lg border border-white/5 flex justify-between items-center">
                        <span class="text-[10px] font-bold text-zinc-500 uppercase">Pollen</span>
                        <span class="text-xs font-mono text-zinc-200">{{ balance !== null ? balance.toFixed(2) : '...' }}</span>
                    </div>
                    <button @click="startDisconnect" class="text-xs text-zinc-600 hover:text-white text-center py-1">Disconnect</button>
                </div>
            </div>
        </div>

        <!-- Overlay -->
        <div v-if="sidebarOpen" @click="sidebarOpen = false" class="fixed inset-0 bg-black/80 z-30 md:hidden backdrop-blur-sm"></div>

        <!-- Main Area -->
        <div class="flex-1 flex flex-col h-full bg-black relative min-w-0">
            <!-- Mobile Header -->
            <div class="h-14 border-b border-white/5 flex items-center px-4 md:hidden shrink-0">
                <button @click="sidebarOpen = true" class="text-zinc-400"><i class="fa-solid fa-bars"></i></button>
                <span class="ml-4 font-medium text-sm">Audio Studio</span>
            </div>

            <div class="flex-1 overflow-y-auto p-6 md:p-12 flex flex-col items-center">
                <div class="w-full max-w-2xl space-y-8">
                    
                    <!-- Config Panel -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 bg-zinc-900/30 rounded-2xl border border-white/5">
                        <div class="space-y-3">
                            <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Model</label>
                            <select v-model="config.model" class="w-full bg-black border border-white/10 text-zinc-200 text-sm rounded-lg p-2.5 focus:border-purple-500/50 outline-none">
                                <option value="tts-1">Standard Speech (TTS-1)</option>
                                <option value="tts-1-hd">HD Speech (TTS-1-HD)</option>
                                <option value="elevenmusic">Music Gen</option>
                            </select>
                        </div>

                        <!-- Voice Selection (TTS) -->
                        <div v-if="config.model !== 'elevenmusic'" class="space-y-3">
                            <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Voice</label>
                            <select v-model="config.voice" class="w-full bg-black border border-white/10 text-zinc-200 text-sm rounded-lg p-2.5 focus:border-purple-500/50 outline-none capitalize">
                                <option v-for="v in voices" :key="v" :value="v">{{ v }}</option>
                            </select>
                        </div>
                        
                        <!-- Duration (Music) -->
                        <div v-else class="space-y-3">
                            <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest flex justify-between">
                                <span>Duration</span>
                                <span class="text-white">{{ config.duration }}s</span>
                            </label>
                            <input type="range" v-model.number="config.duration" min="3" max="300" class="w-full h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer accent-purple-500">
                        </div>

                        <!-- Speed (TTS) -->
                        <div v-if="config.model !== 'elevenmusic'" class="space-y-3">
                             <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest flex justify-between">
                                <span>Speed</span>
                                <span class="text-white">{{ config.speed }}x</span>
                            </label>
                            <input type="range" v-model.number="config.speed" min="0.5" max="2.0" step="0.1" class="w-full h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        </div>

                        <!-- Instrumental (Music) -->
                        <div v-if="config.model === 'elevenmusic'" class="flex items-center justify-between md:col-span-2 pt-2">
                             <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Instrumental Only</label>
                             <input type="checkbox" v-model="config.instrumental" class="accent-purple-500 w-4 h-4">
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="relative">
                        <textarea v-model="input" 
                                  :placeholder="config.model === 'elevenmusic' ? 'Describe the music style (e.g., Lo-fi hip hop beat with jazz piano)...' : 'Type something to hear it speak...'"
                                  class="w-full h-40 bg-zinc-900/50 text-zinc-100 text-lg p-6 rounded-2xl border border-white/10 focus:border-purple-500/50 outline-none resize-none placeholder-zinc-600 transition-colors"
                                  maxlength="4096"></textarea>
                        
                        <div class="absolute bottom-4 right-4">
                             <button @click="generate" :disabled="isGenerating || !input.trim() || !apiKey"
                                class="px-6 py-2 bg-white text-black rounded-full font-bold hover:bg-zinc-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-[0_0_20px_rgba(255,255,255,0.2)] flex items-center gap-2">
                                <i v-if="isGenerating" class="fa-solid fa-circle-notch fa-spin"></i>
                                <span>{{ isGenerating ? 'Generating...' : 'Generate' }}</span>
                            </button>
                        </div>
                    </div>

                    <!-- Active Result -->
                    <transition name="fade">
                        <div v-if="lastResult" class="bg-gradient-to-r from-zinc-900 to-black p-6 rounded-2xl border border-white/10 flex items-center gap-6 shadow-2xl">
                            <div class="w-12 h-12 rounded-full bg-white flex items-center justify-center shrink-0">
                                <i class="fa-solid fa-music text-black text-lg animate-pulse"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm text-zinc-400 mb-2 truncate">{{ lastResult.text }}</div>
                                <audio controls autoplay :src="lastResult.url" class="w-full h-8"></audio>
                            </div>
                            <a :href="lastResult.url" download class="shrink-0 w-10 h-10 flex items-center justify-center rounded-full border border-white/10 hover:bg-white/10 transition-colors">
                                <i class="fa-solid fa-download text-zinc-400"></i>
                            </a>
                        </div>
                    </transition>

                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, watch, nextTick } = Vue;

        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open("PolAudioDB", 1);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains("audio")) {
                    db.createObjectStore("audio", { keyPath: "id" });
                }
            };
            request.onsuccess = (e) => resolve(e.target.result);
            request.onerror = (e) => reject(e);
        });

        async function saveBlob(id, blob) {
            const db = await dbPromise;
            return new Promise((resolve, reject) => {
                const tx = db.transaction("audio", "readwrite");
                tx.objectStore("audio").put({ id, blob });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject();
            });
        }

        async function getBlob(id) {
            const db = await dbPromise;
            return new Promise((resolve) => {
                const tx = db.transaction("audio", "readonly");
                const req = tx.objectStore("audio").get(id);
                req.onsuccess = () => resolve(req.result ? req.result.blob : null);
                req.onerror = () => resolve(null);
            });
        }

        async function deleteBlob(id) {
            const db = await dbPromise;
            const tx = db.transaction("audio", "readwrite");
            tx.objectStore("audio").delete(id);
        }

        createApp({
            setup() {
                const sidebarOpen = ref(false);
                const input = ref('');
                const isGenerating = ref(false);
                const lastResult = ref(null);
                const audioHistory = ref([]);
                const apiKey = ref('');
                const balance = ref(null);
                const modal = ref({ show: false, title: '', message: '', type: 'alert', inputValue: '', captchaTarget: '', onConfirm: null });
                const modalInput = ref(null);
                
                const voices = ["alloy", "echo", "fable", "onyx", "shimmer", "ash", "ballad", "coral", "sage", "verse", "rachel", "domi", "bella", "elli"];
                
                const config = ref({
                    model: 'tts-1',
                    voice: 'alloy',
                    speed: 1.0,
                    duration: 30,
                    instrumental: false
                });

                const loadHistory = async () => {
                    const saved = JSON.parse(localStorage.getItem('pol_pro_audio_meta') || '[]');
                    const hydrated = [];
                    for(const item of saved) {
                        const blob = await getBlob(item.id);
                        if(blob) {
                            item.url = URL.createObjectURL(blob);
                            hydrated.push(item);
                        }
                    }
                    audioHistory.value = hydrated;
                };

                // Custom Modal Helpers
                const showAlert = (title, message) => {
                    modal.value = { show: true, title, message, type: 'alert', onConfirm: () => modal.value.show = false };
                };
                const showConfirm = (title, message, callback) => {
                    modal.value = { show: true, title, message, type: 'confirm', onConfirm: () => { callback(); modal.value.show = false; } };
                };
                const handleModalConfirm = () => { if(modal.value.onConfirm) modal.value.onConfirm(); };

                // Disconnect Logic
                const generateCaptcha = () => Math.random().toString(36).substring(2, 8).toUpperCase();
                
                const startDisconnect = () => {
                    const code = generateCaptcha();
                    modal.value = {
                        show: true,
                        title: 'Security Check',
                        message: 'To disconnect, please type the characters below:',
                        type: 'captcha',
                        captchaTarget: code,
                        inputValue: '',
                        onConfirm: () => {
                            if (modal.value.inputValue.toUpperCase().trim() === modal.value.captchaTarget) {
                                modal.value.show = false;
                                setTimeout(() => {
                                    showConfirm("Confirm Disconnect", "Are you sure you want to disconnect? Your API key will be removed.", logout);
                                }, 300);
                            } else {
                                modal.value.show = false;
                                setTimeout(() => showAlert("Error", "Incorrect CAPTCHA. Action cancelled."), 300);
                            }
                        }
                    };
                    nextTick(() => { if(modalInput.value) modalInput.value.focus(); });
                };

                const generate = async () => {
                    if(!apiKey.value) return;
                    isGenerating.value = true;
                    try {
                        const payload = { model: config.value.model, input: input.value };
                        if(config.value.model === 'elevenmusic') {
                            payload.duration = config.value.duration;
                            payload.instrumental = config.value.instrumental;
                        } else {
                            payload.voice = config.value.voice;
                            payload.speed = config.value.speed;
                            payload.response_format = 'mp3';
                        }

                        const res = await fetch('https://gen.pollinations.ai/v1/audio/speech', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${apiKey.value}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (res.status === 401 || res.status === 403) throw new Error("Unauthorized");
                        if (!res.ok) throw new Error('Generation failed');
                        
                        const blob = await res.blob();
                        const id = Date.now().toString();
                        
                        await saveBlob(id, blob);

                        const item = {
                            id,
                            text: input.value,
                            voice: config.value.model === 'elevenmusic' ? 'Music' : config.value.voice,
                            timestamp: Date.now(),
                            format: 'mp3',
                            url: URL.createObjectURL(blob)
                        };

                        audioHistory.value.unshift(item);
                        lastResult.value = item;
                        
                        const meta = audioHistory.value.map(x => ({...x, url: null})); 
                        localStorage.setItem('pol_pro_audio_meta', JSON.stringify(meta));
                        fetchBalance();
                    } catch(e) { 
                        showAlert("Error", e.message);
                        if(e.message === "Unauthorized") logout();
                    }
                    finally { isGenerating.value = false; }
                };

                const confirmDelete = (id) => {
                    showConfirm("Delete Audio", "Are you sure you want to delete this audio file?", async () => {
                        await deleteBlob(id);
                        audioHistory.value = audioHistory.value.filter(x => x.id !== id);
                        const meta = audioHistory.value.map(x => ({...x, url: null}));
                        localStorage.setItem('pol_pro_audio_meta', JSON.stringify(meta));
                    });
                };

                const login = () => {
                    const redirectUrl = window.location.origin + window.location.pathname.replace('audio.html', 'index.html'); 
                    window.location.href = `https://enter.pollinations.ai/authorize?redirect_url=${encodeURIComponent(redirectUrl)}`;
                };
                
                const logout = () => {
                    localStorage.removeItem('pol_pro_config');
                    apiKey.value = '';
                    balance.value = null;
                };

                const fetchBalance = async () => {
                    if(!apiKey.value) return;
                    try {
                        const r = await fetch('https://gen.pollinations.ai/account/balance', { headers: {'Authorization': `Bearer ${apiKey.value}`} });
                        if(r.ok) { const d = await r.json(); balance.value = d.balance; }
                    } catch(e) {}
                };

                onMounted(() => {
                    try {
                        const sharedConfig = JSON.parse(localStorage.getItem('pol_pro_config'));
                        if(sharedConfig && sharedConfig.apiKey) {
                            apiKey.value = sharedConfig.apiKey;
                            fetchBalance();
                        }
                    } catch(e) {}
                    loadHistory();
                });

                return {
                    sidebarOpen, input, config, isGenerating, audioHistory, lastResult, apiKey, balance, voices, modal, modalInput,
                    generate, confirmDelete, login, logout, startDisconnect, handleModalConfirm
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
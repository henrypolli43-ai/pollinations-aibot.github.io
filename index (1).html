<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pollinations AI - Chat</title>
    
    <!-- CSS Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- JS Libraries -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        black: '#000000',
                        zinc: { 850: '#1f1f22', 900: '#18181b', 950: '#09090b' },
                        accent: { DEFAULT: '#3b82f6', glow: 'rgba(59, 130, 246, 0.5)' }
                    },
                    fontFamily: {
                        mono: ['SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #e4e4e7; height: 100dvh; overflow: hidden; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .raw-text { white-space: pre-wrap; font-family: 'Inter', sans-serif; line-height: 1.7; word-break: break-word; }

        /* Markdown & Code Blocks */
        .markdown-body { font-family: 'Inter', sans-serif; line-height: 1.7; color: #d4d4d8; font-weight: 300; overflow-wrap: break-word; word-wrap: break-word; }
        .markdown-body p { margin-bottom: 1.2em; }
        .markdown-body h1, .markdown-body h2 { color: #fff; margin-top: 1.5em; margin-bottom: 0.8em; font-weight: 600; letter-spacing: -0.02em; }
        .markdown-body a { color: #60a5fa; text-decoration: none; border-bottom: 1px solid rgba(96, 165, 250, 0.3); transition: all 0.2s; }
        .markdown-body img { border-radius: 0.75em; border: 1px solid #27272a; margin: 1em 0; max-width: 100%; height: auto; }

        /* Enhanced Code Block Styles */
        .code-block-wrapper {
            margin: 1.5em 0;
            border: 1px solid #27272a;
            border-radius: 0.75em;
            overflow: hidden;
            background: #09090b;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #18181b;
            border-bottom: 1px solid #27272a;
            font-family: 'SFMono-Regular', monospace;
            font-size: 0.75rem;
            color: #a1a1aa;
            position: sticky; /* Sticky Header */
            top: 0;
            z-index: 5;
        }
        .markdown-body pre { 
            margin: 0 !important; 
            padding: 1em; 
            border: none; 
            background: transparent !important; 
            border-radius: 0;
        }
        
        /* Inner Code Styling - Grayish Color & Safety */
        .markdown-body pre code {
            font-family: 'SFMono-Regular', monospace;
            font-size: 0.85em;
            color: #a1a1aa !important; /* Grayish text */
            background: transparent !important;
            text-shadow: none !important;
        }
        
        /* Inline Code */
        .markdown-body :not(pre) > code { 
            background-color: #27272a; 
            padding: 0.2em 0.4em; 
            border-radius: 0.4em; 
            font-family: 'SFMono-Regular', monospace;
            font-size: 0.85em;
            color: #d4d4d8; 
        }

        /* Animations */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-right-enter-active, .slide-right-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-right-enter-from, .slide-right-leave-to { transform: translateX(100%); }
        .slide-left-enter-active, .slide-left-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-left-enter-from, .slide-left-leave-to { transform: translateX(-100%); }
    </style>
</head>
<body class="bg-black text-zinc-300 overflow-hidden flex selection:bg-blue-500/30 selection:text-white">

    <div id="app" class="flex w-full h-full relative">

        <!-- ================= CUSTOM MODAL ================= -->
        <transition name="fade">
            <div v-if="modal.show" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm">
                <div class="bg-zinc-900 border border-white/10 p-6 rounded-2xl max-w-sm w-full mx-4 shadow-2xl transform transition-all scale-100">
                    <h3 class="text-lg font-bold text-white mb-2 tracking-tight">{{ modal.title }}</h3>
                    <p class="text-sm text-zinc-400 mb-6 font-light leading-relaxed">{{ modal.message }}</p>
                    
                    <!-- Prompt Input -->
                    <input v-if="modal.type === 'prompt'" 
                           ref="modalInput" 
                           v-model="modal.inputValue" 
                           type="text" 
                           class="w-full bg-black border border-white/10 rounded-lg p-3 text-sm text-white mb-6 focus:border-blue-500/50 outline-none" 
                           placeholder="Enter URL here..." 
                           @keydown.enter="handleModalConfirm">

                    <!-- CAPTCHA Display & Input -->
                    <div v-if="modal.type === 'captcha'" class="mb-6">
                        <div class="bg-zinc-800 p-4 rounded-lg text-center mb-4 font-mono text-2xl tracking-[0.5em] font-bold text-white select-none relative overflow-hidden border border-white/5">
                            {{ modal.captchaTarget }}
                            <!-- Visual Noise -->
                            <div class="absolute inset-0 opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1IiBoZWlnaHQ9IjUiPgo8cmVjdCB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMSIvPjwvc3ZnPg==')]"></div>
                        </div>
                        <input ref="modalInput"
                               v-model="modal.inputValue"
                               type="text"
                               class="w-full bg-black border border-white/10 rounded-lg p-3 text-sm text-white focus:border-blue-500/50 outline-none text-center uppercase tracking-widest font-mono"
                               placeholder="TYPE CODE"
                               @keydown.enter="handleModalConfirm">
                    </div>

                    <div class="flex gap-3 justify-end">
                        <button v-if="modal.type !== 'alert'" @click="modal.show = false" class="px-4 py-2 text-xs font-medium text-zinc-400 hover:text-white transition-colors">Cancel</button>
                        <button @click="handleModalConfirm" class="px-4 py-2 text-xs font-medium bg-white text-black rounded-lg hover:bg-zinc-200 transition-colors shadow-lg shadow-white/10">Confirm</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- ================= LEFT SIDEBAR ================= -->
        <transition name="slide-left">
            <div v-show="sidebars.left" 
                 class="fixed inset-y-0 left-0 z-40 w-72 bg-black border-r border-white/5 flex flex-col transition-transform duration-300 md:relative shadow-2xl shadow-black">
                
                <!-- Header -->
                <div class="p-5 border-b border-white/5">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-2 font-semibold text-white tracking-tight">
                            <i class="fa-solid fa-bolt text-blue-500 text-sm"></i>
                            <span>Pollinations</span>
                        </div>
                        <button @click="sidebars.left = false" class="text-zinc-500 hover:text-white transition-colors p-1" title="Close Sidebar">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                    </div>

                    <div class="flex bg-zinc-900 p-1 rounded-xl border border-white/5 mb-6">
                        <button class="flex-1 py-2 text-xs font-medium rounded-lg bg-zinc-800 text-white shadow-lg transition-all text-center tracking-wide">
                            Chat
                        </button>
                        <a href="audio.html" class="flex-1 py-2 text-xs font-medium rounded-lg text-zinc-500 hover:text-zinc-300 transition-all text-center tracking-wide">
                            Audio
                        </a>
                    </div>

                    <div class="flex justify-between items-center px-1">
                        <h2 class="font-medium text-white tracking-tight text-sm opacity-80 uppercase text-[10px] letter-spacing-2">Library</h2>
                        <button @click="createNewSession" class="text-zinc-500 hover:text-white transition-colors" title="New Chat">
                            <i class="fa-solid fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>

                <!-- Chat Session List -->
                <div class="flex-1 overflow-y-auto p-3 space-y-1">
                    <div v-for="session in sessions" :key="session.id" 
                         @click="loadSession(session.id)"
                         class="group p-3 rounded-xl cursor-pointer text-sm flex items-center justify-between transition-all border border-transparent"
                         :class="currentSessionId === session.id ? 'bg-zinc-900 text-white border-white/5' : 'text-zinc-500 hover:bg-zinc-900/50 hover:text-zinc-300'">
                        
                        <div class="flex items-center overflow-hidden gap-3">
                            <i class="fa-regular fa-message text-[10px]"></i>
                            <span class="truncate font-light">{{ session.title || 'Untitled Session' }}</span>
                        </div>
                        
                        <button @click.stop="confirmDeleteSession(session.id)" class="text-zinc-600 hover:text-red-400 transition-opacity p-1">
                            <i class="fa-solid fa-xmark text-xs"></i>
                        </button>
                    </div>
                </div>

                <!-- Footer (BYOP) -->
                <div class="p-4 border-t border-white/5 bg-black">
                    <button v-if="!config.apiKey" @click="login" 
                            class="w-full mb-3 py-2.5 px-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-medium text-xs transition-all shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 group">
                        <i class="fa-solid fa-bolt text-white/80 group-hover:text-white"></i>
                        <span>Connect Pollinations</span>
                    </button>

                    <div v-else class="mb-3 space-y-2">
                        <div class="px-3 py-2 bg-zinc-900/50 rounded-lg border border-white/5 flex justify-between items-center">
                             <div class="flex items-center gap-2">
                                <i class="fa-solid fa-seedling text-[10px] text-green-500"></i>
                                <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Pollen</span>
                            </div>
                            <span class="text-xs font-mono text-zinc-200">{{ userBalance !== null ? userBalance.toFixed(2) : '...' }}</span>
                        </div>
                         <button @click="startDisconnect" class="w-full py-1.5 text-xs text-zinc-600 hover:text-red-400 transition-colors">Disconnect</button>
                    </div>

                    <button @click="toggleSettings" 
                            class="w-full flex items-center justify-between p-3 bg-zinc-900/50 hover:bg-zinc-900 text-zinc-400 hover:text-white rounded-xl transition-all border border-white/5 group">
                        <span class="text-xs font-medium ml-1">Settings</span>
                        <i class="fa-solid fa-sliders text-xs mr-1 opacity-50 group-hover:opacity-100"></i>
                    </button>
                </div>
            </div>
        </transition>

        <div v-if="sidebars.left && isMobile" @click="sidebars.left = false" class="fixed inset-0 bg-black/50 z-40 backdrop-blur-sm md:hidden"></div>

        <!-- ================= MAIN CHAT AREA ================= -->
        <div class="flex-1 flex flex-col min-w-0 bg-black relative h-full">
            
            <div class="h-14 border-b border-white/5 flex items-center justify-between px-4 md:hidden bg-black/90 backdrop-blur sticky top-0 z-20 shrink-0">
                <button @click="sidebars.left = true" class="text-zinc-400"><i class="fa-solid fa-bars"></i></button>
                <span class="font-medium text-sm text-zinc-200">{{ config.model }}</span>
                <button @click="sidebars.right = true" class="text-zinc-400"><i class="fa-solid fa-sliders"></i></button>
            </div>

            <div class="hidden md:flex absolute top-5 left-5 z-10">
                <button v-if="!sidebars.left" @click="sidebars.left = true" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </div>

            <!-- Messages Container -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 min-h-0">
                
                <div v-if="!currentSessionId || getMessages().length === 0" class="h-full flex flex-col items-center justify-center text-zinc-500 space-y-6 animate-fade-in">
                    <div class="w-16 h-16 rounded-full bg-zinc-900 border border-white/5 flex items-center justify-center shadow-[0_0_30px_rgba(59,130,246,0.1)]">
                        <i class="fa-solid fa-bolt text-2xl text-blue-500"></i>
                    </div>
                    <div class="text-center">
                        <h3 class="text-lg font-medium text-white mb-2">Pollinations Pro</h3>
                        <p class="text-sm text-zinc-600 max-w-xs mx-auto font-light">Advanced AI models. Zero latency.</p>
                    </div>
                     <button v-if="!config.apiKey" @click="login" 
                            class="px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-full font-medium text-sm transition-all shadow-lg shadow-blue-900/30 flex items-center gap-2">
                        <span>Connect to Start</span>
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>

                <div v-else class="max-w-3xl mx-auto space-y-10 pb-4">
                    <div v-for="(msg, index) in getMessages()" :key="index" class="group animate-slide-up">
                        <div class="flex items-center justify-between mb-3 px-1">
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold tracking-widest uppercase" :class="msg.role === 'user' ? 'text-zinc-500' : 'text-blue-500'">{{ msg.role === 'user' ? 'You' : config.model }}</span>
                            </div>
                            <div class="flex gap-3 transition-opacity">
                                <button v-if="!msg.isEditing" @click="enableEdit(index)" class="text-zinc-600 hover:text-white transition-colors"><i class="fa-solid fa-pen text-xs"></i></button>
                                <button v-if="!msg.isEditing" @click="copyContent(msg.content)" class="text-zinc-600 hover:text-white transition-colors"><i class="fa-regular fa-copy text-xs"></i></button>
                            </div>
                        </div>

                        <div class="relative">
                            <div v-if="msg.isEditing" class="bg-zinc-900 rounded-xl border border-blue-500/30 p-4">
                                <textarea v-model="msg.editDraft" rows="4" class="w-full bg-transparent text-sm text-zinc-200 focus:outline-none font-mono resize-y"></textarea>
                                <div class="flex justify-end gap-2 mt-3">
                                    <button @click="cancelEdit(index)" class="text-xs px-3 py-1 text-zinc-500 hover:text-white">Cancel</button>
                                    <button @click="saveEdit(index)" class="text-xs px-3 py-1 bg-blue-600 rounded-md text-white hover:bg-blue-500">Save Update</button>
                                </div>
                            </div>
                            <div v-else :class="msg.role === 'user' ? 'text-zinc-100' : 'text-zinc-300'">
                                <template v-if="Array.isArray(msg.content)">
                                    <div v-for="(part, pIdx) in msg.content" :key="pIdx">
                                        <div v-if="part.type === 'text' && part.text.startsWith('Filename:')" class="mb-4">
                                            <div class="inline-flex items-center gap-3 bg-zinc-900/50 border border-white/5 rounded-lg px-3 py-2 pr-4">
                                                <div class="bg-zinc-800 p-1.5 rounded text-blue-400 text-xs"><i class="fa-solid fa-code"></i></div>
                                                <div class="flex flex-col"><span class="text-xs text-zinc-300 font-mono">{{ getFileName(part.text) }}</span></div>
                                            </div>
                                        </div>
                                        <div v-else-if="part.type === 'image_url'" class="mb-4">
                                            <div class="inline-block overflow-hidden rounded-xl border border-white/10"><img :src="part.image_url.url" class="max-h-64 w-auto object-cover opacity-90 hover:opacity-100 transition-opacity"></div>
                                        </div>
                                        <div v-else-if="part.type === 'text'"><div v-if="config.renderMarkdown" class="markdown-body" v-markdown="part.text"></div><div v-else class="raw-text text-[15px]">{{ part.text }}</div></div>
                                    </div>
                                </template>
                                <template v-else>
                                    <div v-if="config.renderMarkdown" class="markdown-body" v-markdown="msg.content"></div>
                                    <div v-else class="raw-text text-[15px]">{{ msg.content }}</div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div v-if="isStreaming" class="flex items-center gap-3 text-blue-500/80 animate-pulse">
                        <div class="w-2 h-2 rounded-full bg-blue-500"></div><span class="text-xs font-mono uppercase tracking-widest">Generating</span>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="shrink-0 w-full p-4 md:p-6 bg-black z-20 border-t border-white/5">
                <div class="max-w-3xl mx-auto">
                    <div v-if="pendingFiles.length > 0" class="flex gap-2 mb-3 overflow-x-auto pb-1 scrollbar-hide">
                        <div v-for="(file, idx) in pendingFiles" :key="idx" class="flex items-center gap-2 bg-zinc-900 border border-white/10 rounded-full px-3 py-1 shrink-0 animate-fade-in">
                            <i v-if="file.uploading" class="fa-solid fa-circle-notch fa-spin text-zinc-500 text-xs"></i>
                            <i v-else :class="file.type === 'image' ? 'fa-regular fa-image text-purple-400' : 'fa-regular fa-file-code text-blue-400'" class="text-xs"></i>
                            <span class="text-xs text-zinc-300 truncate max-w-[100px]">{{ file.name }}</span>
                            <button @click="removePendingFile(idx)" class="text-zinc-500 hover:text-white ml-1"><i class="fa-solid fa-times text-xs"></i></button>
                        </div>
                    </div>

                    <div class="relative group">
                        <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-3xl blur opacity-0 group-focus-within:opacity-100 transition duration-500"></div>
                        <div class="relative bg-zinc-900 border border-white/10 rounded-3xl flex items-end shadow-2xl">
                            <textarea v-model="input" @keydown.enter.exact.prevent="sendMessage" ref="textarea" rows="1" class="w-full bg-transparent text-zinc-200 placeholder-zinc-600 text-[15px] px-5 py-4 rounded-3xl focus:outline-none resize-none max-h-48 scrollbar-hide" placeholder="Send a message..." style="min-height: 56px;"></textarea>
                            <div class="flex items-center gap-1 pb-2.5 pr-3">
                                <label class="p-2 text-zinc-500 hover:text-zinc-200 rounded-full hover:bg-white/5 cursor-pointer transition-all" title="Attach File"><i class="fa-solid fa-paperclip text-sm"></i><input type="file" multiple @change="handleFileUpload" class="hidden" :accept="isMultimodal ? '*/*' : '.txt,.js,.py,.html,.css,.json,.md,.c,.cpp,.h,.java,.rb,.go,.rs,.ts,.php'"></label>
                                <button @click="promptForImageUrl" class="p-2 text-zinc-500 hover:text-zinc-200 rounded-full hover:bg-white/5 transition-all" title="Add Image URL"><i class="fa-solid fa-link text-sm"></i></button>
                                <button v-if="!isStreaming" @click="sendMessage" :disabled="(!input.trim() && pendingFiles.length === 0) || pendingFiles.some(f => f.uploading)" class="ml-1 p-2 h-9 w-9 flex items-center justify-center bg-zinc-100 text-black rounded-full hover:bg-white disabled:opacity-30 disabled:cursor-not-allowed transition-all shadow-lg"><i class="fa-solid fa-arrow-up text-sm"></i></button>
                                <button v-else @click="stopStream" class="ml-1 p-2 h-9 w-9 flex items-center justify-center bg-zinc-800 text-white rounded-full hover:bg-zinc-700 border border-white/10 transition-all"><i class="fa-solid fa-stop text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= RIGHT SIDEBAR: SETTINGS ================= -->
        <transition name="slide-right">
            <div v-show="sidebars.right" class="fixed inset-y-0 right-0 z-50 w-80 bg-[#050505] border-l border-white/5 shadow-2xl flex flex-col">
                <div class="p-5 border-b border-white/5 flex justify-between items-center bg-black/50 backdrop-blur">
                    <h2 class="font-medium text-white tracking-wide">Configuration</h2>
                    <button @click="sidebars.right = false" class="text-zinc-500 hover:text-white transition-colors"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 space-y-8">
                    <!-- Models -->
                    <div class="space-y-3">
                        <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Model Selection</label>
                        <div class="relative">
                            <select v-model="config.model" class="w-full bg-zinc-900 border border-white/10 text-white text-sm rounded-lg p-3 outline-none appearance-none">
                                <option v-for="m in models" :key="m" :value="m">{{ m }}</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-3 top-4 text-xs text-zinc-600 pointer-events-none"></i>
                        </div>
                        <div class="flex items-center gap-2 text-[10px] text-zinc-500 mt-1">
                            <span v-if="isMultimodal" class="px-1.5 py-0.5 rounded bg-purple-500/10 text-purple-400 border border-purple-500/20">Vision</span>
                            <span v-if="supportsReasoning" class="px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-400 border border-blue-500/20">Reasoning</span>
                        </div>
                    </div>

                    <!-- Output Settings (Stream Removed - Always On) -->
                    <div class="space-y-3 border-t border-b border-white/5 py-4">
                        <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Output Settings</label>
                         <div class="flex items-center justify-between">
                            <span class="text-sm text-zinc-400">Render Markdown</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" v-model="config.renderMarkdown" class="sr-only peer">
                                <div class="w-9 h-5 bg-zinc-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-400 after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-white peer-checked:after:bg-black peer-checked:after:border-transparent"></div>
                            </label>
                        </div>
                         <div class="flex items-center justify-between">
                            <span class="text-sm text-zinc-400">JSON Mode</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" v-model="config.jsonMode" class="sr-only peer">
                                <div class="w-9 h-5 bg-zinc-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-400 after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600 peer-checked:after:bg-white"></div>
                            </label>
                        </div>
                    </div>

                    <!-- System Prompt & Params -->
                    <div class="space-y-4 pt-2">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">System Prompt</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" v-model="toggles.systemPrompt" class="sr-only peer">
                                <div class="w-7 h-4 bg-zinc-800 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-500 after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600 peer-checked:after:bg-white"></div>
                            </label>
                        </div>
                        <transition name="fade">
                            <div v-if="toggles.systemPrompt"><textarea v-model="config.systemPrompt" rows="3" class="w-full bg-zinc-900 border border-white/10 text-zinc-300 text-xs rounded-lg p-3 focus:border-blue-500/50 outline-none resize-none leading-relaxed" placeholder="Define AI behavior..."></textarea></div>
                        </transition>
                    </div>

                    <div class="space-y-4 pt-2">
                         <div class="flex items-center justify-between">
                            <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Model Parameters</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" v-model="toggles.parameters" class="sr-only peer">
                                <div class="w-7 h-4 bg-zinc-800 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-500 after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600 peer-checked:after:bg-white"></div>
                            </label>
                        </div>
                        <transition name="fade">
                            <div v-if="toggles.parameters" class="space-y-6 bg-zinc-900/30 p-4 rounded-xl border border-white/5">
                                <div>
                                    <div class="flex justify-between mb-2"><span class="text-xs text-zinc-400">Temperature</span><span class="text-xs text-white font-mono">{{ config.temperature }}</span></div>
                                    <input type="range" v-model.number="config.temperature" min="0" max="2" step="0.1" class="w-full h-1 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-white">
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2"><span class="text-xs text-zinc-400">Max Tokens</span><span class="text-xs text-white font-mono">{{ config.maxTokens }}</span></div>
                                    <input type="range" v-model.number="config.maxTokens" min="100" max="16000" step="100" class="w-full h-1 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-white">
                                </div>
                            </div>
                        </transition>
                    </div>

                    <div v-if="supportsReasoning" class="p-4 bg-blue-900/10 rounded-xl border border-blue-500/20 space-y-3">
                         <div class="flex items-center justify-between">
                            <span class="text-xs font-medium text-blue-400">Enable Reasoning</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" v-model="config.reasoningEnabled" class="sr-only peer">
                                <div class="w-7 h-4 bg-zinc-800 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-500 after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600 peer-checked:after:bg-white"></div>
                            </label>
                        </div>
                        <div v-if="config.reasoningEnabled">
                             <select v-model="config.reasoningEffort" class="w-full bg-black border border-blue-500/20 text-blue-200 text-xs rounded p-2">
                                <option value="low">Low Effort</option><option value="medium">Medium Effort</option><option value="high">High Effort</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <div v-if="sidebars.right && isMobile" @click="sidebars.right = false" class="fixed inset-0 bg-black/50 z-40 backdrop-blur-sm md:hidden"></div>
    </div>

    <script>
        const { createApp, ref, computed, watch, nextTick, onMounted } = Vue;

        const app = createApp({
            directives: {
                markdown: {
                    mounted(el, binding) { updateContent(el, binding.value); },
                    updated(el, binding) { updateContent(el, binding.value); }
                }
            },
            setup() {
                const models = ['openai', 'openai-large', 'openai-fast', 'claude-fast', 'nomnom', 'gemini-fast', 'gemini-search', 'deepseek', 'qwen-coder', 'kimi', 'minimax', 'glm', 'nova-micro', 'perplexity-fast', 'perplexity-reasoning', 'mistral', 'qwen-character'];
                const reasoningModels = ['deepseek', 'perplexity-reasoning', 'openai-large', 'minimax', 'glm', 'kimi'];
                const multimodalModels = ['nomnom', 'mistral', 'claude-fast', 'gemini-search', 'perplexity-fast', 'perplexity-reasoning', 'gemini-fast', 'openai-fast', 'openai', 'openai-large', 'kimi'];
                
                const sidebars = ref({ left: window.innerWidth > 1024, right: false });
                const isMobile = ref(window.innerWidth <= 768);
                const input = ref('');
                const pendingFiles = ref([]);
                const isStreaming = ref(false);
                const currentSessionId = ref(null);
                const sessions = ref([]);
                const textarea = ref(null);
                let abortController = null;
                const toggles = ref({ systemPrompt: false, parameters: false });
                const userBalance = ref(null);
                let balanceInterval = null;

                // Modal State
                // Types: alert, confirm, prompt, captcha
                const modal = ref({ show: false, title: '', message: '', type: 'alert', inputValue: '', captchaTarget: '', onConfirm: null });
                const modalInput = ref(null);

                const config = ref({
                    apiKey: '', model: 'openai', systemPrompt: 'You are a helpful expert assistant.',
                    temperature: 0.7, maxTokens: 4096, reasoningEnabled: false, reasoningEffort: 'medium',
                    renderMarkdown: true, jsonMode: false 
                });

                const saveToStorage = () => {
                    localStorage.setItem('pol_pro_config', JSON.stringify(config.value));
                    localStorage.setItem('pol_pro_sessions', JSON.stringify(sessions.value));
                    localStorage.setItem('pol_pro_toggles', JSON.stringify(toggles.value));
                };

                const loadFromStorage = () => {
                    try {
                        const c = JSON.parse(localStorage.getItem('pol_pro_config'));
                        if (c) config.value = { ...config.value, ...c };
                        const s = JSON.parse(localStorage.getItem('pol_pro_sessions'));
                        if (s) sessions.value = s;
                        const t = JSON.parse(localStorage.getItem('pol_pro_toggles'));
                        if (t) toggles.value = t;
                    } catch(e) { console.error("Load error", e); }
                };

                const supportsReasoning = computed(() => reasoningModels.includes(config.value.model));
                const isMultimodal = computed(() => multimodalModels.includes(config.value.model));
                const getMessages = () => {
                    if (!currentSessionId.value) return [];
                    const s = sessions.value.find(x => x.id === currentSessionId.value);
                    return s ? s.messages : [];
                };

                const scrollToBottom = () => {
                    nextTick(() => {
                        const c = document.getElementById('chat-container');
                        if (c) c.scrollTo({ top: c.scrollHeight, behavior: 'auto' });
                    });
                };

                const login = () => {
                    const redirectUrl = window.location.origin + window.location.pathname;
                    window.location.href = `https://enter.pollinations.ai/authorize?redirect_url=${encodeURIComponent(redirectUrl)}`;
                };

                const logout = () => {
                    config.value.apiKey = '';
                    userBalance.value = null;
                    saveToStorage();
                    if(balanceInterval) clearInterval(balanceInterval);
                };

                const fetchBalance = async () => {
                    if (!config.value.apiKey) return;
                    try {
                        const res = await fetch('https://gen.pollinations.ai/account/balance', { headers: { 'Authorization': `Bearer ${config.value.apiKey}` } });
                        if (res.ok) { const data = await res.json(); userBalance.value = data.balance; }
                    } catch (e) { console.error("Failed to fetch balance", e); }
                };

                const startBalancePolling = () => {
                    if (balanceInterval) clearInterval(balanceInterval);
                    if (config.value.apiKey) { fetchBalance(); balanceInterval = setInterval(fetchBalance, 4000); } 
                    else userBalance.value = null;
                };

                // === Custom Modal System ===
                const showAlert = (title, message) => {
                    modal.value = { show: true, title, message, type: 'alert', onConfirm: () => modal.value.show = false };
                };
                const showConfirm = (title, message, callback) => {
                    modal.value = { show: true, title, message, type: 'confirm', onConfirm: () => { callback(); modal.value.show = false; } };
                };
                const showPrompt = (title, message, callback) => {
                    modal.value = { 
                        show: true, title, message, type: 'prompt', inputValue: '',
                        onConfirm: () => { 
                            if(modal.value.inputValue.trim()) { callback(modal.value.inputValue.trim()); }
                            modal.value.show = false; 
                        } 
                    };
                    nextTick(() => { if(modalInput.value) modalInput.value.focus(); });
                };
                
                // Disconnect Logic
                const generateCaptcha = () => Math.random().toString(36).substring(2, 8).toUpperCase();
                
                const startDisconnect = () => {
                    const code = generateCaptcha();
                    modal.value = {
                        show: true,
                        title: 'Security Check',
                        message: 'To disconnect, please type the characters below:',
                        type: 'captcha',
                        captchaTarget: code,
                        inputValue: '',
                        onConfirm: () => {
                            if (modal.value.inputValue.toUpperCase().trim() === modal.value.captchaTarget) {
                                modal.value.show = false;
                                setTimeout(() => {
                                    showConfirm("Confirm Disconnect", "Are you sure you want to disconnect? Your API key will be removed.", logout);
                                }, 300);
                            } else {
                                modal.value.show = false;
                                setTimeout(() => showAlert("Error", "Incorrect CAPTCHA. Action cancelled."), 300);
                            }
                        }
                    };
                    nextTick(() => { if(modalInput.value) modalInput.value.focus(); });
                };

                const handleModalConfirm = () => { if(modal.value.onConfirm) modal.value.onConfirm(); };


                const createNewSession = () => {
                    currentSessionId.value = null; input.value = ''; pendingFiles.value = [];
                    if (isMobile.value) sidebars.value.left = false;
                    textarea.value.focus();
                };

                const loadSession = (id) => {
                    currentSessionId.value = id;
                    if (isMobile.value) sidebars.value.left = false;
                    scrollToBottom();
                };

                const confirmDeleteSession = (id) => {
                    showConfirm("Delete Chat", "Are you sure you want to delete this session? This action cannot be undone.", () => {
                        sessions.value = sessions.value.filter(s => s.id !== id);
                        if (currentSessionId.value === id) createNewSession();
                        saveToStorage();
                    });
                };

                const sendMessage = async () => {
                    if (!config.value.apiKey) { login(); return; }
                    const text = input.value.trim();
                    if (!text && pendingFiles.value.length === 0) return;

                    if (!currentSessionId.value) {
                        const id = Date.now().toString();
                        sessions.value.unshift({ id, title: text.substring(0, 30) || 'New Chat', messages: [], timestamp: Date.now() });
                        currentSessionId.value = id;
                    }

                    const session = sessions.value.find(s => s.id === currentSessionId.value);
                    const content = [];
                    pendingFiles.value.forEach(f => {
                        if (f.type === 'image') content.push({ type: 'image_url', image_url: { url: f.content } });
                        else content.push({ type: 'text', text: `Filename: ${f.name}\n${f.content}` });
                    });
                    if (text) content.push({ type: 'text', text });

                    session.messages.push({ role: 'user', content, isEditing: false });
                    input.value = ''; pendingFiles.value = [];
                    scrollToBottom(); isStreaming.value = true;

                    const apiMsgs = [];
                    if (config.value.systemPrompt && toggles.value.systemPrompt) apiMsgs.push({ role: 'system', content: config.value.systemPrompt });
                    session.messages.forEach(m => {
                        let c = Array.isArray(m.content) ? m.content.map(p => ({...p})) : [{type:'text', text: m.content}];
                        apiMsgs.push({ role: m.role, content: c });
                    });

                    // Forced Stream: true
                    const payload = { model: config.value.model, messages: apiMsgs, stream: true };
                    if (toggles.value.parameters) { payload.temperature = config.value.temperature; payload.max_tokens = config.value.maxTokens; }
                    if (config.value.reasoningEnabled && supportsReasoning.value) payload.reasoning_effort = config.value.reasoningEffort;
                    if (config.value.jsonMode) payload.response_format = { type: 'json_object' };

                    abortController = new AbortController();
                    try {
                        const res = await fetch('https://gen.pollinations.ai/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${config.value.apiKey}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                            signal: abortController.signal
                        });
                        if (res.status === 401 || res.status === 403) throw new Error("Unauthorized. Please connect again.");

                        session.messages.push({ role: 'assistant', content: '', isEditing: false });
                        const aiMsg = session.messages[session.messages.length - 1];

                        const reader = res.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            let lines = buffer.split('\n');
                            
                            // Keep the last part in buffer if it doesn't end with newline
                            buffer = lines.pop() || ''; 

                            for (const line of lines) {
                                const trimmed = line.trim();
                                if (!trimmed || trimmed === 'data: [DONE]') continue;
                                if (trimmed.startsWith('data: ')) {
                                    try {
                                        const json = JSON.parse(trimmed.slice(6));
                                        if (json.choices && json.choices[0].delta.content) {
                                            aiMsg.content += json.choices[0].delta.content;
                                            scrollToBottom();
                                        }
                                    } catch(e) {}
                                }
                            }
                        }
                        // Flush any remaining buffer at the end
                        if (buffer.trim().startsWith('data: ')) {
                            try {
                                const json = JSON.parse(buffer.trim().slice(6));
                                if (json.choices && json.choices[0].delta.content) {
                                    aiMsg.content += json.choices[0].delta.content;
                                    scrollToBottom();
                                }
                            } catch(e) {}
                        }

                    } catch (e) {
                        if (e.name !== 'AbortError') session.messages.push({ role: 'assistant', content: `Error: ${e.message}` });
                        if (e.message.includes('Unauthorized')) logout();
                    } finally {
                        isStreaming.value = false; saveToStorage(); fetchBalance(); setTimeout(() => scrollToBottom(), 100);
                    }
                };

                const handleFileUpload = async (e) => {
                    const files = Array.from(e.target.files);
                    for (const f of files) {
                        if (f.type.startsWith('image/')) {
                             const tempId = Date.now() + Math.random();
                             pendingFiles.value.push({ type: 'image', name: f.name, content: '', uploading: true, id: tempId });
                             const formData = new FormData(); formData.append('file', f);
                             fetch('https://tmpfiles.org/api/v1/upload', {method:'POST', body: formData})
                                .then(r=>r.json()).then(d=>{
                                    const pf = pendingFiles.value.find(x=>x.id===tempId);
                                    if(pf) { pf.content = d.data.url.replace('tmpfiles.org/', 'tmpfiles.org/dl/'); pf.uploading = false; }
                                });
                        } else {
                            const t = await f.text();
                            pendingFiles.value.push({ type: 'text', name: f.name, content: t });
                        }
                    }
                    e.target.value = '';
                };
                
                const promptForImageUrl = () => {
                    if (!isMultimodal.value) { showAlert("Error", `Model ${config.value.model} does not support images.`); return; }
                    showPrompt("Add Image URL", "Please paste the public image URL below:", (url) => {
                        if (url && (url.startsWith('http') || url.startsWith('https'))) {
                            pendingFiles.value.push({ type: 'image', name: 'Image from URL', content: url.trim(), uploading: false, id: Date.now() });
                        }
                    });
                };

                const getFileName = (t) => { const m = t.match(/Filename: (.*?)\n/); return m ? m[1] : 'File'; };
                const removePendingFile = (i) => pendingFiles.value.splice(i, 1);
                const stopStream = () => { if(abortController) abortController.abort(); isStreaming.value = false; };
                const copyContent = (c) => { navigator.clipboard.writeText(Array.isArray(c) ? c.filter(p=>p.type==='text').map(p=>p.text).join('\n') : c); };
                
                const enableEdit = (i) => {
                    const m = getMessages()[i];
                    m.editDraft = Array.isArray(m.content) ? m.content.find(p=>p.type==='text' && !p.text.startsWith('Filename:'))?.text || '' : m.content;
                    m.isEditing = true;
                };
                const cancelEdit = (i) => getMessages()[i].isEditing = false;
                const saveEdit = (i) => {
                    const m = getMessages()[i];
                    if(Array.isArray(m.content)) {
                        const idx = m.content.findIndex(p=>p.type==='text' && !p.text.startsWith('Filename:'));
                        if(idx > -1) m.content[idx].text = m.editDraft; else m.content.push({type:'text', text: m.editDraft});
                    } else m.content = m.editDraft;
                    m.isEditing = false; saveToStorage();
                };

                watch(input, () => { if(textarea.value) { textarea.value.style.height = 'auto'; textarea.value.style.height = Math.min(textarea.value.scrollHeight, 200) + 'px'; }});
                watch([config, toggles], saveToStorage, { deep: true });
                watch(() => config.value.apiKey, startBalancePolling);
                window.addEventListener('resize', () => isMobile.value = window.innerWidth <= 768);
                
                onMounted(() => {
                    loadFromStorage();
                    const hash = window.location.hash;
                    if (hash.includes('api_key=')) {
                        const key = new URLSearchParams(hash.substring(1)).get('api_key');
                        if (key) { config.value.apiKey = key; saveToStorage(); history.replaceState(null, null, ' '); }
                    }
                    startBalancePolling();
                });

                return {
                    models, sidebars, isMobile, input, pendingFiles, isStreaming, currentSessionId, sessions, config, toggles, textarea,
                    supportsReasoning, isMultimodal, userBalance, modal, modalInput,
                    createNewSession, loadSession, confirmDeleteSession, sendMessage, stopStream, handleFileUpload, removePendingFile,
                    getMessages, getFileName, copyContent, enableEdit, cancelEdit, saveEdit, handleModalConfirm,
                    toggleSettings: () => sidebars.value.right = !sidebars.value.right, promptForImageUrl, login, startDisconnect, logout
                };
            }
        });
        
        app.mount('#app');

        window.copyCode = function(btn) {
            const code = btn.nextElementSibling ? btn.nextElementSibling.innerText : '';
            navigator.clipboard.writeText(code).then(() => {
                const icon = btn.querySelector('i');
                icon.className = 'fa-solid fa-check text-green-500';
                setTimeout(() => icon.className = 'fa-regular fa-copy', 2000);
            });
        };

        function updateContent(el, text) {
            if (!text) { el.innerHTML = ''; return; }
            
            const renderer = new marked.Renderer();
            renderer.code = function(code, language) {
                // Fix for Marked v14+: code is an object { text, lang }
                if (typeof code === 'object' && code.text) {
                    language = code.lang;
                    code = code.text;
                }
                const lang = (language || 'text').split('.')[0];
                
                // Explicitly escape HTML entities to prevent execution
                code = code.replace(/&/g, "&amp;")
                           .replace(/</g, "&lt;")
                           .replace(/>/g, "&gt;")
                           .replace(/"/g, "&quot;")
                           .replace(/'/g, "&#039;");

                return `
                <div class="code-block-wrapper">
                    <div class="code-header">
                        <span>${lang}</span>
                        <button onclick="copyCode(this)" class="hover:text-white transition-colors" title="Copy code">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                        <div style="display:none">${code}</div>
                    </div>
                    <pre><code class="language-${lang}">${code}</code></pre>
                </div>`;
            };

            const mathMap = [];
            let protectedText = text.replace(/(\$\$[\s\S]+?\$\$)|(\\\([\s\S]+?\\\))/g, (match) => {
                const id = `MATHPLACEHOLDER${mathMap.length}`;
                mathMap.push(match);
                return id;
            });

            marked.use({ renderer });
            let html = marked.parse(protectedText);
            mathMap.forEach((match, i) => { html = html.replace(`MATHPLACEHOLDER${i}`, match); });
            el.innerHTML = html;

            if (window.renderMathInElement) {
                renderMathInElement(el, { 
                    delimiters: [{left: '$$', right: '$$', display: true}, {left: '\\(', right: '\\)', display: false}], 
                    throwOnError: false, errorColor: '#cc0000'
                });
            }
            if (window.Prism) Prism.highlightAllUnder(el);
        }
    </script>
</body>
</html>